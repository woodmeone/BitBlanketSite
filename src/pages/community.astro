---
import BaseLayout from '../layouts/BaseLayout.astro';
import CollageCard from '../components/collage/CollageCard.astro';
import SuggestionForm from '../components/SuggestionForm.vue';
import VoteButton from '../components/VoteButton.vue';
import { getPublicSuggestions } from '../lib/data-service';

const suggestions = await getPublicSuggestions(Astro);

const typeLabels: Record<string, string> = {
  topic: '选题建议',
  article: '文章建议',
  project: '项目建议',
  other: '其他'
};

const statusLabels: Record<string, string> = {
  pending: '待审核',
  approved: '已采纳',
  in_progress: '进行中',
  completed: '已完成',
  rejected: '已拒绝'
};

const pendingCount = suggestions.filter(s => s.status === 'pending').length;
const approvedCount = suggestions.filter(s => s.status === 'approved').length;
const inProgressCount = suggestions.filter(s => s.status === 'in_progress').length;
const completedCount = suggestions.filter(s => s.status === 'completed').length;

const formatDate = (dateStr: string) => {
  if (!dateStr) return '';
  const date = new Date(dateStr);
  return date.toLocaleDateString('zh-CN');
};
---

<BaseLayout title="粉丝互动">
  <div class="space-y-8">
    <section class="text-center py-8">
      <CollageCard rotation={-0.5} class="inline-block px-8 py-4">
        <h1 class="text-3xl md:text-4xl font-bold">粉丝互动</h1>
      </CollageCard>
      <p class="text-muted-foreground mt-4 max-w-2xl mx-auto">
        提交你的建议，投票选出你感兴趣的内容
      </p>
    </section>

    <div class="grid md:grid-cols-2 gap-8">
      <CollageCard rotation={-0.8} class="p-6">
        <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
          <div class="w-2 h-6 bg-accent" />
          提交建议
        </h2>
        <SuggestionForm client:load />
      </CollageCard>

      <CollageCard rotation={0.8} class="p-6">
        <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
          <div class="w-2 h-6 bg-accent" />
          热门建议
        </h2>
        <div class="space-y-3" id="suggestions-list">
          {suggestions.map((suggestion) => (
            <div class="p-3 border-2 border-primary/20 flex items-center justify-between relative overflow-hidden">
              {suggestion.status === 'approved' && (
                <div class="absolute top-0 right-0">
                  <div class="approved-badge">
                    <span class="approved-text">已采纳</span>
                  </div>
                </div>
              )}
              <div class="flex-1 min-w-0 pr-16">
                <div class="flex items-center gap-2 mb-1 flex-wrap">
                  <span class="px-2 py-0.5 text-xs bg-secondary">{typeLabels[suggestion.type] || suggestion.type}</span>
                  {suggestion.status !== 'pending' && suggestion.status !== 'rejected' && (
                    <span class={`px-2 py-0.5 text-xs rounded-full status-badge status-${suggestion.status}`}>
                      {statusLabels[suggestion.status] || suggestion.status}
                    </span>
                  )}
                  <span class="text-xs text-muted-foreground">来自：{suggestion.nickname || '匿名'}</span>
                  <span class="text-xs text-muted-foreground">{formatDate(suggestion.created_at)}</span>
                </div>
                <p class="font-medium truncate">{suggestion.content}</p>
                {suggestion.reply && (
                  <div class="mt-2 p-2 bg-indigo-50 dark:bg-indigo-900/20 border-l-2 border-indigo-500 text-xs text-muted-foreground">
                    <span class="font-medium">回复：</span>{suggestion.reply}
                  </div>
                )}
              </div>
              <VoteButton 
                client:load 
                suggestionId={suggestion.id} 
                initialVotes={suggestion.votes || 0} 
              />
            </div>
          ))}
          
          {suggestions.length === 0 && (
            <div class="text-center text-muted-foreground py-4">
              暂无建议，快来提交第一条吧！
            </div>
          )}
        </div>
      </CollageCard>
    </div>

    <CollageCard rotation={-0.3} class="p-6">
      <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
        <div class="w-2 h-6 bg-accent" />
        建议状态
      </h2>
      <div class="grid grid-cols-2 md:grid-cols-5 gap-4 text-center">
        <div class="p-4 border-2 border-primary/20">
          <div class="text-2xl font-bold">{pendingCount}</div>
          <div class="text-sm text-muted-foreground">待审核</div>
        </div>
        <div class="p-4 border-2 border-primary/20">
          <div class="text-2xl font-bold text-green-500">{approvedCount}</div>
          <div class="text-sm text-muted-foreground">已采纳</div>
        </div>
        <div class="p-4 border-2 border-primary/20">
          <div class="text-2xl font-bold text-amber-500">{inProgressCount}</div>
          <div class="text-sm text-muted-foreground">进行中</div>
        </div>
        <div class="p-4 border-2 border-primary/20">
          <div class="text-2xl font-bold text-blue-500">{completedCount}</div>
          <div class="text-sm text-muted-foreground">已完成</div>
        </div>
        <div class="p-4 border-2 border-primary/20">
          <div class="text-2xl font-bold text-accent">{suggestions.length}</div>
          <div class="text-sm text-muted-foreground">总建议</div>
        </div>
      </div>
    </CollageCard>

    <CollageCard rotation={0.5} class="p-6 text-center bg-accent text-accent-foreground">
      <h2 class="text-xl font-bold mb-2">感谢你的参与！</h2>
      <p class="text-accent-foreground/90">
        每一条建议我都会认真阅读，期待与你一起成长
      </p>
    </CollageCard>
  </div>
</BaseLayout>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const suggestionsList = document.getElementById('suggestions-list');
    
    const stored = localStorage.getItem('bit-blanket-suggestions');
    if (stored) {
      const suggestions = JSON.parse(stored);
      if (suggestions.length > 0) {
        console.log('已加载用户建议:', suggestions.length, '条');
      }
    }
  });
</script>

<style>
  .approved-badge {
    width: 80px;
    height: 80px;
    overflow: hidden;
    position: relative;
  }

  .approved-badge::before {
    content: '';
    position: absolute;
    top: -8px;
    right: -32px;
    width: 120px;
    height: 24px;
    background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
    transform: rotate(45deg);
    box-shadow: 0 2px 8px rgba(34, 197, 94, 0.4);
    animation: badge-shine 2s ease-in-out infinite;
  }

  .approved-text {
    position: absolute;
    top: 12px;
    right: 4px;
    font-size: 10px;
    font-weight: bold;
    color: white;
    transform: rotate(45deg);
    z-index: 1;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    animation: text-pulse 2s ease-in-out infinite;
  }

  @keyframes badge-shine {
    0%, 100% {
      filter: brightness(1);
    }
    50% {
      filter: brightness(1.2);
    }
  }

  @keyframes text-pulse {
    0%, 100% {
      opacity: 1;
    }
    50% {
      opacity: 0.8;
    }
  }

  .status-badge {
    animation: fade-in 0.5s ease-out;
  }

  .status-approved {
    background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
    color: #166534;
    border: 1px solid #86efac;
  }

  .status-in_progress {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    color: #92400e;
    border: 1px solid #fcd34d;
  }

  .status-completed {
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    color: #1e40af;
    border: 1px solid #93c5fd;
  }

  @keyframes fade-in {
    from {
      opacity: 0;
      transform: translateY(-4px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .dark .status-approved {
    background: linear-gradient(135deg, #14532d 0%, #166534 100%);
    color: #bbf7d0;
    border: 1px solid #22c55e;
  }

  .dark .status-in_progress {
    background: linear-gradient(135deg, #78350f 0%, #92400e 100%);
    color: #fde68a;
    border: 1px solid #f59e0b;
  }

  .dark .status-completed {
    background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
    color: #bfdbfe;
    border: 1px solid #3b82f6;
  }
</style>
