---
import BaseLayout from '../layouts/BaseLayout.astro';
import CollageCard from '../components/collage/CollageCard.astro';
import { getPublishedSoftware } from '../lib/data-service';

const software = await getPublishedSoftware(Astro);

const platforms = [
  { id: 'all', label: 'å…¨éƒ¨å¹³å°' },
  { id: 'windows', label: 'Windows' },
  { id: 'mac', label: 'macOS' },
  { id: 'linux', label: 'Linux' },
  { id: 'web', label: 'Web' },
];

const platformIcons: Record<string, string> = {
  windows: 'ğŸªŸ',
  mac: 'ğŸ',
  linux: 'ğŸ§',
  web: 'ğŸŒ',
};

const softwareData = software.map(item => ({
  id: item.id,
  name: item.name,
  description: item.description,
  content: item.content,
  platform: item.platform,
  category: item.category,
  website: item.website,
  download_url: item.download_url,
  hidden_content: item.hidden_content
}));
---

<BaseLayout title="åˆ†äº«">
  <div class="space-y-8">
    <section class="text-center py-8">
      <CollageCard rotation={-0.5} class="inline-block px-8 py-4">
        <h1 class="text-3xl md:text-4xl font-bold">åˆ†äº«</h1>
      </CollageCard>
      <p class="text-muted-foreground mt-4 max-w-2xl mx-auto">
        ç²¾é€‰å®ç”¨è½¯ä»¶å·¥å…·ï¼Œæå‡ä½ çš„å·¥ä½œæ•ˆç‡
      </p>
    </section>

    <section class="max-w-xl mx-auto">
      <CollageCard rotation={0.3} class="p-4">
        <div class="relative">
          <input 
            type="text" 
            id="search-input"
            placeholder="æœç´¢è½¯ä»¶..."
            class="w-full px-4 py-2 pl-10 border-2 border-primary/20 bg-input-background focus:border-primary/40 outline-none"
          />
          <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </div>
      </CollageCard>
    </section>

    <section class="flex flex-wrap gap-2 justify-center" id="platforms-container">
      {platforms.map((platform, index) => (
        <button class:list={['nav-item platform-btn', index === 0 ? 'nav-item-active' : 'nav-item-inactive']} data-platform={platform.id}>
          {platform.label}
        </button>
      ))}
    </section>

    <section class="grid md:grid-cols-2 gap-6" id="software-container">
      {software.map((item, index) => {
        const rotation = ((index % 2) - 0.5) * 1.2;
        const platformList = (item.platform || '').split(',').filter(p => p.trim());
        return (
          <div 
            class="software-card" 
            data-name={item.name}
            data-description={item.description || ''}
            data-platform={platformList.join(',')}
            data-category={item.category || ''}
          >
            <CollageCard rotation={rotation} class="p-6 cursor-pointer">
              <div class="flex items-start justify-between mb-3">
                <div>
                  <h2 class="text-xl font-bold">{item.name}</h2>
                </div>
                <div class="flex gap-1">
                  {platformList.map((p) => (
                    <span class="text-lg" title={p}>{platformIcons[p] || 'ğŸ“¦'}</span>
                  ))}
                </div>
              </div>
              <p class="text-muted-foreground text-sm mb-4">{item.description || ''}</p>
              
              {item.content && (
                <div class="text-muted-foreground text-sm mb-4 prose prose-sm dark:prose-invert max-w-none"
                  set:html={item.content}>
                </div>
              )}
              
              {item.hidden_content && (
                <div class="mb-4">
                  <button class="text-sm text-accent hover:underline hidden-toggle" data-id={item.id}>
                    ğŸ”’ ç‚¹å‡»æŸ¥çœ‹éšè—å†…å®¹
                  </button>
                  <div class="hidden hidden-content mt-2 p-3 bg-yellow-50 dark:bg-yellow-900/20 border-2 border-yellow-200 dark:border-yellow-800 rounded" data-id={item.id}>
                    <p class="text-sm whitespace-pre-wrap">{item.hidden_content}</p>
                  </div>
                </div>
              )}
              
              <div class="flex items-center justify-between">
                <span class="text-xs text-muted-foreground">
                  {item.category || 'å…¶ä»–'}
                </span>
                <div class="flex gap-2">
                  {item.download_url && (
                    <a href={item.download_url} target="_blank" rel="noopener noreferrer">
                      <button class="nav-item nav-item-active text-sm px-3 py-1">
                        ä¸‹è½½
                      </button>
                    </a>
                  )}
                  {item.website && (
                    <a href={item.website} target="_blank" rel="noopener noreferrer">
                      <button class="nav-item nav-item-inactive text-sm px-3 py-1">
                        è®¿é—®
                      </button>
                    </a>
                  )}
                </div>
              </div>
            </CollageCard>
          </div>
        );
      })}
    </section>

    {software.length === 0 && (
      <section class="text-center text-muted-foreground">
        <CollageCard rotation={0} class="inline-block px-8 py-4">
          <p>æš‚æ— åˆ†äº«å†…å®¹</p>
        </CollageCard>
      </section>
    )}

    <section class="text-center text-muted-foreground" id="no-results" style="display: none;">
      <CollageCard rotation={0} class="inline-block px-8 py-4">
        <p>æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„è½¯ä»¶</p>
      </CollageCard>
    </section>
  </div>
</BaseLayout>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.getElementById('search-input') as HTMLInputElement;
    const softwareContainer = document.getElementById('software-container');
    const noResults = document.getElementById('no-results');
    const platformButtons = document.querySelectorAll('.platform-btn');
    
    let currentPlatform = 'all';
    let currentSearch = '';
    
    function filterSoftware() {
      const softwareCards = softwareContainer?.querySelectorAll('.software-card');
      let visibleCount = 0;
      
      softwareCards?.forEach((card) => {
        const el = card as HTMLElement;
        const name = el.dataset.name?.toLowerCase() || '';
        const description = el.dataset.description?.toLowerCase() || '';
        const platforms = el.dataset.platform?.split(',') || [];
        const searchLower = currentSearch.toLowerCase();
        
        const matchesSearch = !currentSearch || 
          name.includes(searchLower) || 
          description.includes(searchLower);
        
        const matchesPlatform = currentPlatform === 'all' || platforms.includes(currentPlatform);
        
        const shouldShow = matchesSearch && matchesPlatform;
        el.style.display = shouldShow ? '' : 'none';
        
        if (shouldShow) visibleCount++;
      });
      
      if (noResults) {
        noResults.style.display = visibleCount === 0 ? '' : 'none';
      }
    }
    
    searchInput?.addEventListener('input', (e) => {
      currentSearch = (e.target as HTMLInputElement).value;
      filterSoftware();
    });
    
    platformButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        platformButtons.forEach(b => {
          b.classList.remove('nav-item-active');
          b.classList.add('nav-item-inactive');
        });
        btn.classList.remove('nav-item-inactive');
        btn.classList.add('nav-item-active');
        
        currentPlatform = (btn as HTMLElement).dataset.platform || 'all';
        filterSoftware();
      });
    });
    
    document.querySelectorAll('.hidden-toggle').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const id = (btn as HTMLElement).dataset.id;
        const content = document.querySelector(`.hidden-content[data-id="${id}"]`);
        if (content) {
          content.classList.toggle('hidden');
          btn.textContent = content.classList.contains('hidden') ? 'ğŸ”’ ç‚¹å‡»æŸ¥çœ‹éšè—å†…å®¹' : 'ğŸ”“ æ”¶èµ·éšè—å†…å®¹';
        }
      });
    });
  });
</script>
