---
import BaseLayout from '../../layouts/BaseLayout.astro';
import CollageCard from '../../components/collage/CollageCard.astro';
import { getPublishedSoftware } from '../../lib/data-service';

const software = await getPublishedSoftware(Astro);

const platforms = [
  { id: 'all', label: 'å…¨éƒ¨å¹³å°' },
  { id: 'windows', label: 'Windows' },
  { id: 'mac', label: 'macOS' },
  { id: 'linux', label: 'Linux' },
  { id: 'web', label: 'Web' },
];

const platformIcons: Record<string, string> = {
  windows: 'ğŸªŸ',
  mac: 'ğŸ',
  linux: 'ğŸ§',
  web: 'ğŸŒ',
};

const softwareData = software.map(item => ({
  id: item.id,
  slug: item.slug || String(item.id),
  name: item.name,
  description: item.description,
  platform: item.platform,
  category: item.category,
  rating: item.rating || 0
}));
---

<BaseLayout title="åˆ†äº«">
  <div class="space-y-8">
    <section class="text-center py-8">
      <CollageCard rotation={-0.5} class="inline-block px-8 py-4">
        <h1 class="text-3xl md:text-4xl font-bold">åˆ†äº«</h1>
      </CollageCard>
      <p class="text-muted-foreground mt-4 max-w-2xl mx-auto">
        ç²¾é€‰å®ç”¨è½¯ä»¶å·¥å…·ï¼Œæå‡ä½ çš„å·¥ä½œæ•ˆç‡
      </p>
    </section>

    <section class="max-w-xl mx-auto">
      <CollageCard rotation={0.3} class="p-4">
        <div class="relative">
          <input 
            type="text" 
            id="search-input"
            placeholder="æœç´¢è½¯ä»¶..."
            class="w-full px-4 py-2 pl-10 border-2 border-primary/20 bg-input-background focus:border-primary/40 outline-none"
          />
          <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </div>
      </CollageCard>
    </section>

    <section class="flex flex-wrap gap-2 justify-center" id="platforms-container">
      {platforms.map((platform, index) => (
        <button class:list={['nav-item platform-btn', index === 0 ? 'nav-item-active' : 'nav-item-inactive']} data-platform={platform.id}>
          {platform.label}
        </button>
      ))}
    </section>

    <section class="grid md:grid-cols-2 lg:grid-cols-3 gap-6" id="software-container">
      {softwareData.map((item, index) => {
        const rotation = ((index % 3) - 1) * 0.8;
        const platformList = (item.platform || '').split(',').filter(p => p.trim());
        return (
          <a 
            href={`/software/${item.slug}`}
            class="software-card block" 
            data-name={item.name}
            data-description={item.description || ''}
            data-platform={platformList.join(',')}
            data-category={item.category || ''}
          >
            <CollageCard rotation={rotation} class="p-6 h-full hover:shadow-lg transition-shadow">
              <div class="flex items-start justify-between mb-3">
                <div class="flex-1">
                  <h2 class="text-xl font-bold hover:text-accent transition-colors">{item.name}</h2>
                </div>
                <div class="flex gap-1 ml-2">
                  {platformList.map((p) => (
                    <span class="text-lg" title={p}>{platformIcons[p] || 'ğŸ“¦'}</span>
                  ))}
                </div>
              </div>
              <p class="text-muted-foreground text-sm mb-3 line-clamp-2">{item.description || ''}</p>
              
              <div class="flex items-center justify-between">
                <span class="text-xs text-muted-foreground">
                  {item.category || 'å…¶ä»–'}
                </span>
                <span class="text-xs text-muted-foreground flex items-center gap-1">
                  <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                  </svg>
                  {item.rating}
                </span>
              </div>
            </CollageCard>
          </a>
        );
      })}
    </section>

    {softwareData.length === 0 && (
      <section class="text-center text-muted-foreground">
        <CollageCard rotation={0} class="inline-block px-8 py-4">
          <p>æš‚æ— åˆ†äº«å†…å®¹</p>
        </CollageCard>
      </section>
    )}

    <section class="text-center text-muted-foreground" id="no-results" style="display: none;">
      <CollageCard rotation={0} class="inline-block px-8 py-4">
        <p>æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„è½¯ä»¶</p>
      </CollageCard>
    </section>
  </div>
</BaseLayout>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.getElementById('search-input') as HTMLInputElement;
    const softwareContainer = document.getElementById('software-container');
    const noResults = document.getElementById('no-results');
    const platformButtons = document.querySelectorAll('.platform-btn');
    
    let currentPlatform = 'all';
    let currentSearch = '';
    
    function filterSoftware() {
      const softwareCards = softwareContainer?.querySelectorAll('.software-card');
      let visibleCount = 0;
      
      softwareCards?.forEach((card) => {
        const el = card as HTMLElement;
        const name = el.dataset.name?.toLowerCase() || '';
        const description = el.dataset.description?.toLowerCase() || '';
        const platforms = el.dataset.platform?.split(',') || [];
        const searchLower = currentSearch.toLowerCase();
        
        const matchesSearch = !currentSearch || 
          name.includes(searchLower) || 
          description.includes(searchLower);
        
        const matchesPlatform = currentPlatform === 'all' || platforms.includes(currentPlatform);
        
        const shouldShow = matchesSearch && matchesPlatform;
        el.style.display = shouldShow ? '' : 'none';
        
        if (shouldShow) visibleCount++;
      });
      
      if (noResults) {
        noResults.style.display = visibleCount === 0 ? '' : 'none';
      }
    }
    
    searchInput?.addEventListener('input', (e) => {
      currentSearch = (e.target as HTMLInputElement).value;
      filterSoftware();
    });
    
    platformButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        platformButtons.forEach(b => {
          b.classList.remove('nav-item-active');
          b.classList.add('nav-item-inactive');
        });
        btn.classList.remove('nav-item-inactive');
        btn.classList.add('nav-item-active');
        
        currentPlatform = (btn as HTMLElement).dataset.platform || 'all';
        filterSoftware();
      });
    });
  });
</script>
